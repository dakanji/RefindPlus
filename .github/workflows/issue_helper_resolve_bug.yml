name: 'Issue Helper Resolve Bug'

on:
  workflow_dispatch:
    inputs:
      item_id:
        description: 'Item ID'
        required: true
      commit_ref:
        description: 'Commit Ref'
        required: true
      show_build_msg:
        type: choice
        description: 'Version Comment'
        options:
        - 'Yes'
        - 'No'
      more_info:
        description: 'More Info'
      show_more_info:
        type: choice
        description: 'Show More Info Entry'
        options:
        - 'No'
        - 'Yes'
      type_more_info:
        type: choice
        description: 'More Info Type'
        options:
        - 'Note'
        - 'Caution'

permissions:
  issues: write

concurrency:
  group: lock

jobs:

  issue_resolve_bug1:
    name: Issue - Resolve - Bug1
    runs-on: ubuntu-24.04

    steps:
      - id: issue-get-state
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.inputs.item_id;
            const { data } = await github.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            if (data.locked) {
              console.log("::set-output name=islocked::true");
            } else {
              console.log("::set-output name=islocked::false");
            }
            if (data.state === 'closed') {
              console.log("::set-output name=isclosed::true");
            } else {
              console.log("::set-output name=isclosed::false");
            }

  # Misc Issue Items - https://github.com/actions-cool/issues-helper
  issue_resolve_bug2:
    name: Issue - Resolve - Bug2
    needs: [issue_resolve_bug1]
    runs-on: ubuntu-24.04

    if: ${{ success() || failure() }}
    steps:
      - if: ${{ steps.issue-get-state.outputs.islocked == 'true' }}
        id: part_2_1
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'unlock-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}

      - if: ${{ github.event.inputs.show_build_msg == 'Yes' }}
        id: part_2_2a
        uses: oprypin/find-latest-tag@v1
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}
          releases-only: true

      - if: ${{ github.event.inputs.show_build_msg == 'Yes' && github.event.inputs.show_more_info == 'Yes' && github.event.inputs.type_more_info == 'Note' }}
        id: part_2_2b
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}
          body: |
            This item was addressed by Commit ${{ github.event.inputs.commit_ref }}.

            The current RefindPlus release is **${{ steps.part_2_2a.outputs.tag }}**.
            See [BUILDING.md](https://github.com/dakanji/RefindPlus/blob/GOPFix/BUILDING.md) for how to access functionality ahead of releases.

            > [!NOTE]
            > ${{ github.event.inputs.more_info }}

            Thank you for taking the time to report a problem with RefindPlus.

      - if: ${{ github.event.inputs.show_build_msg == 'Yes' && github.event.inputs.show_more_info == 'Yes' && github.event.inputs.type_more_info == 'Caution' }}
        id: part_2_2c
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}
          body: |
            This item was addressed by Commit ${{ github.event.inputs.commit_ref }}.

            The current RefindPlus release is **${{ steps.part_2_2a.outputs.tag }}**.
            See [BUILDING.md](https://github.com/dakanji/RefindPlus/blob/GOPFix/BUILDING.md) for how to access functionality ahead of releases.

            > [!CAUTION]
            > ${{ github.event.inputs.more_info }}

            Thank you for taking the time to report a problem with RefindPlus.

      - if: ${{ github.event.inputs.show_build_msg == 'Yes' && github.event.inputs.show_more_info == 'No' }}
        id: part_2_2d
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}
          body: |
            This item was addressed by Commit ${{ github.event.inputs.commit_ref }}.

            The current RefindPlus release is **${{ steps.part_2_2a.outputs.tag }}**.
            See [BUILDING.md](https://github.com/dakanji/RefindPlus/blob/GOPFix/BUILDING.md) for how to access functionality ahead of releases.

            Thank you for taking the time to report a problem with RefindPlus.

      - if: ${{ github.event.inputs.show_build_msg == 'No' && github.event.inputs.show_more_info == 'Yes' && github.event.inputs.type_more_info == 'Note' }}
        id: part_2_3a
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}
          body: |
            This item was addressed by Commit ${{ github.event.inputs.commit_ref }}.

            > [!NOTE]
            > ${{ github.event.inputs.more_info }}

            Thank you for taking the time to report a problem with RefindPlus.

      - if: ${{ github.event.inputs.show_build_msg == 'No' && github.event.inputs.show_more_info == 'Yes' && github.event.inputs.type_more_info == 'Caution' }}
        id: part_2_3b
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}
          body: |
            This item was addressed by Commit ${{ github.event.inputs.commit_ref }}.

            > [!CAUTION]
            > ${{ github.event.inputs.more_info }}

            Thank you for taking the time to report a problem with RefindPlus.

      - if: ${{ github.event.inputs.show_build_msg == 'No' && github.event.inputs.show_more_info == 'No' }}
        id: part_2_3c
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}
          body: |
            This item was addressed by Commit ${{ github.event.inputs.commit_ref }}.

            Thank you for taking the time to report a problem with RefindPlus.

  issue_resolve_bug3:
    name: Issue - Resolve - Bug3
    needs: [issue_resolve_bug2]
    runs-on: ubuntu-24.04

    if: ${{ success() || failure() }}
    steps:
      - id: part_3_1
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'add-labels'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}
          labels: 'Bug,Resolved'

      - id: part_3_2
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'remove-labels'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}
          labels: 'Triage,Queries,Parked,Prorogued,Unclear,Uncertain,Unresolved,Acknowledged,Known-Issue'

  issue_resolve_bug4:
    name: Issue - Resolve - Bug4
    needs: [issue_resolve_bug3]
    runs-on: ubuntu-24.04

    if: ${{ success() || failure() }}
    steps:
      - if: ${{ steps.issue-get-state.outputs.isclosed == 'false' }}
        id: part_4_1
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issue'
          close-reason: 'completed'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}

      - if: ${{ steps.issue-get-state.outputs.islocked == 'true' }}
        id: part_4_2
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'lock-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.item_id }}
